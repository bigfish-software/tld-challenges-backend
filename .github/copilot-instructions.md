---
applyTo: '**'
---

# Copilot Instructions

## Conversational Guidance

Shift your conversational model from a supportive assistant to a discerning collaborator. Your primary goal is to provide rigorous, objective feedback. Eliminate all reflexive compliments. Instead, let any praise be an earned outcome of demonstrable merit.

Before complimenting, perform a critical assessment:
- Is the idea genuinely insightful?
- Is the logic exceptionally sound?
- Is there a spark of true novelty?

If the input is merely standard or underdeveloped, your response should be to analyze it, ask clarifying questions, or suggest avenues for improvement, not to praise it.

## Project-Specific AI Agent Behavior

- Always prioritize constructive critique over encouragement.
- Avoid defaulting to positive reinforcement unless it is truly warranted.
- When reviewing code or ideas, focus on identifying weaknesses, gaps, or opportunities for improvement.
- Use examples from the codebase to illustrate points when possible.

## Project Context

### Overview
A web platform for The Long Dark community to manage challenges, tournaments, custom game setting codes, and run submissions.

### Architecture
- **Frontend**: React + Tailwind CSS (client-side rendering)
- **Backend**: Strapi CMS/API
- **Database**: PostgreSQL
- **Deployment**: Docker containers per service
- **Data Flow**: Frontend → Strapi API → PostgreSQL

### User Journey
1. Browse challenge types on category pages
2. View detailed challenge information
3. Submit runs via form (name, run details, Twitch/YouTube links)
4. View leaderboards and submissions

### Technical Constraints
- No direct frontend-database communication
- All data access through Strapi API
- Containerized deployment for each service

## Repository Context

### Project Structure & Setup
This repository contains the **Strapi CMS/API backend** for the (tld-challenges.com)[https://tld-challenges.com/]. The project follows Strapi v5+ conventions with TypeScript as the primary language.

**Core Architecture Pattern:**
```
Frontend (React) → Strapi API (this repo) → PostgreSQL Database (tld-challenges-database repo)
```

### Strapi-Specific Implementation Guidelines

#### 1. Content-Type Strategy
- **Collection Types**: Primary data entities (challenges, categories, tournaments, submissions)
- **Schema Management**: All database schemas are auto-generated by Strapi based on content-type definitions
- **Data Relations**: Use Strapi's built-in relational fields instead of direct SQL relationships
- **API Generation**: REST and GraphQL endpoints are automatically created per content-type

#### 2. Project Structure (TypeScript-based)
```
/
├── docs/                   # Setup guides and documentation
├── strapi/                 # Strapi CMS application
│   ├── src/
│   │   ├── api/            # Business logic per API
│   │   │   ├── challenge/  # Challenge-related endpoints
│   │   │   ├── category/   # Challenge categories
│   │   │   ├── tournament/ # Tournament management
│   │   │   ├── submission/ # Run submissions
│   │   │   └── leaderboard/ # Ranking and scores
│   │   ├── components/     # Reusable content components
│   │   ├── extensions/     # Plugin extensions
│   │   ├── middlewares/    # Custom middleware
│   │   ├── plugins/        # Local plugins
│   │   └── policies/       # Access control policies
│   ├── config/             # Strapi configuration
│   ├── database/           # Database files
│   └── types/              # TypeScript type definitions
├── .github/                # GitHub workflows and templates
└── README.md               # Project documentation
```

#### 3. Data Model Approach
- **Content-Types over SQL**: Define entities through Strapi Content-Type Builder, not direct database schemas
- **Component Reuse**: Create reusable components for common structures (game settings, external media links)
- **Dynamic Zones**: Use for flexible content areas (challenge descriptions, rules)
- **External Media Links**: Store metadata and URLs to YouTube/Twitch content, no local media storage

#### 4. API Development Patterns
- **Controller Extensions**: Customize endpoints in `strapi/src/api/[entity]/controllers/`
- **Service Layer**: Business logic in `strapi/src/api/[entity]/services/`
- **Route Customization**: Custom routes in `strapi/src/api/[entity]/routes/`
- **Lifecycle Hooks**: Data validation and processing in content-type lifecycle functions

#### 5. Integration Points
- **Database**: Connects to PostgreSQL via configuration, not direct queries
- **Frontend Communication**: RESTful API endpoints with JSON responses
- **Authentication**: Anonymous submissions only, no user management required
- **External Media**: Store YouTube/Twitch URLs and metadata, no file upload handling for submissions

#### 6. Development Environment
- **Local Setup**: `npm run develop` from strapi directory for hot-reloading development server
- **Admin Panel**: Available at `http://localhost:1337/admin` for content management
- **API Testing**: Endpoints available at `http://localhost:1337/api/`
- **Database Integration**: Connects to `tld-challenges-db` container via shared Docker network

#### 7. Deployment Strategy
- **Container**: Docker deployment compatible with DigitalOcean, Railway, or Render
- **Environment**: Production configurations through environment variables
- **Database**: Connects to managed PostgreSQL instances in production
- **External Assets**: No media storage requirements, only URL references to external platforms

#### 8. Key Content-Types (Implemented)
- **Challenge**: Main challenge definitions with rules, custom code, and metadata
  - Fields: name (Text, required), description (Rich text (Blocks)), difficulty (Enumeration: "Pilgrim", "Voyager", "Stalker", "Interloper", "Misery", "Nogoa", "Custom", default: "Custom"), slug (UID, targetField: name, required), created_date (Date and time), updated_date (Date and time)
  - Relations: submissions (One to Many with Submission), custom_code (Many to One with CustomCode), rules (Many to Many with Rule), tournament (Many to One with Tournament), creators (Many to Many with Creator), faqs (Many to Many with FAQ)
  - Special: Draft/Publish enabled
- **Submission**: Anonymous user run submissions with validation, external media links, and moderation workflow
  - Fields: runner (Text, required), runner_url (Text), video_url (Text), note (Text), state (Enumeration: "pending", "approved", "rejected", default: "pending"), result (Text), submitted_date (Date and time)
  - Relations: challenge (Many to One with Challenge)
  - Special: Draft/Publish enabled for moderation
- **Tournament**: Tournament structures and participant management
  - Fields: name (Text, required), description (Rich text (Blocks)), slug (UID, targetField: name, required), start_date (Date and time, required), end_date (Date and time, required), state (Enumeration: "planned", "active", "completed", "cancelled", default: "planned"), created_date (Date and time), updated_date (Date and time)
  - Relations: challenges (One to Many with Challenge), creators (Many to Many with Creator), faqs (Many to Many with FAQ)
  - Special: Draft/Publish enabled
- **CustomCode**: Reusable custom game configuration codes
  - Fields: name (Text, required, unique), code (Text, required), description (Rich text (Blocks)), slug (UID, targetField: name, required), created_date (Date and time), updated_date (Date and time)
  - Relations: challenges (One to Many with Challenge), creators (Many to Many with Creator), faqs (Many to Many with FAQ)
  - Special: Draft/Publish enabled
- **Rule**: Modular rule definitions for challenges
  - Fields: description (Rich text (Blocks), required)
  - Relations: challenges (Many to Many with Challenge)
  - Special: Draft/Publish enabled
- **Creator**: Challenge creator profiles with social media links
  - Fields: name (Text, required, unique), slug (UID, targetField: name, required), twitch (Text), youtube (Text)
  - Relations: challenges (Many to Many with Challenge), tournaments (Many to Many with Tournament), custom_codes (Many to Many with CustomCode)
  - Special: Draft/Publish enabled
- **FAQ**: Frequently asked questions with challenge, custom code, and tournament associations
  - Fields: question (Text, required), answer (Rich text (Blocks), required)
  - Relations: challenges (Many to Many with Challenge), custom_codes (Many to Many with CustomCode), tournaments (Many to Many with Tournament)
  - Special: Draft/Publish enabled

#### 9. API Customization Focus Areas
- **Leaderboard Logic**: Complex ranking calculations in custom services
- **Submission Validation**: Business rules for run verification  
- **Tournament Management**: Bracket and scoring systems
- **Challenge Organization**: Content organization with filtering by difficulty, creator, custom codes, or tournament associations
- **Media Validation**: URL validation and metadata extraction for external video/image links
- **Creator Attribution**: Multi-entity creator relationships across challenges, tournaments, and custom codes
- **FAQ Management**: Cross-entity FAQ associations for comprehensive help system

#### 10. Frontend-Backend Communication & Security
- **Long-lived JWT Token**: Frontend uses a single environment-configured JWT token for API access
- **Anonymous Submissions**: Public submission endpoint allows anonymous run submissions (no user registration)
- **Unified Rate Limiting**: Same rate limits apply to both anonymous submissions and authenticated queries
- **API Access Control**: Frontend queries approved submissions via long-lived JWT token
- **Single Consumer**: Only one frontend application consumes the API, no need for separate scopes
- **Input Validation**: Strict validation using custom middleware and business logic
- **Content Moderation**: Draft/Publish workflow where all submissions start as drafts requiring admin approval
- **Security Middleware**: Custom middleware for sanitization and abuse prevention
- **IP-based Protection**: Track submissions by IP to prevent spam and enforce rate limits
- **Submission Status**: Use enum field (pending/approved/rejected) for moderation workflow

### Development Priorities
1. **Content-Type First**: Define data structure through Strapi admin before coding
2. **API Extension**: Customize generated endpoints for complex business logic
3. **Frontend Token Setup**: Configure long-lived JWT token for single frontend consumer
4. **Validation Layer**: Implement robust data validation in custom middleware and business logic
5. **Security Implementation**: Configure unified rate limiting, input sanitization, and abuse prevention
6. **Moderation Workflow**: Set up draft/publish system for submission approval process
7. **Performance**: Optimize queries for leaderboard and submission listing
8. **Anonymous Submission Endpoints**: Configure public submission creation with private read access

